
# 基于 PSO-MCTS 算法的住宅户型自动生成  
## 技术实现思路文档  

---

## 一、背景需求与目标  

本项目旨在实现一个自动生成住宅户型平面布局的算法，给定一系列建筑平面的约束条件（户型边界、房间类型和数量、朝向要求、开窗需求等），算法需自动生成满足约束的房间布置方案，使用论文中提到的 **粒子群优化(PSO) + 蒙特卡洛树搜索(MCTS)** 方法。

最终实现目标为：

- 在合理的计算时间内自动输出满足“硬约束”和尽可能满足“软约束”的户型布局。
- 输出房间的坐标、长宽尺寸和房间类型，并自动给出评分。

---

## 二、输入数据与参数设定  

### （一）基础输入数据  

- **户型边界**：以矩形或多边形描述，给出顶点坐标，可开窗的外墙边界，入口门的位置。
- **房间类型列表**：如[bedroom, living room, kitchen, bathroom]等。
- **房间尺寸范围**：各类房间的长宽/面积范围。
- **朝向要求**：指定特定房间（如卧室）必须在南侧采光面。
- **开窗条件**：房间必须靠近特定的外墙才能开窗。
- **房间连接关系**（相邻关系）：房间间预定义的相邻需求，例如厨房邻近餐厅，卫生间靠近卧室等。

---

### （二）约束条件的详细定义

**硬约束**（必须严格满足）：

| 序号 | 约束项   | 约束说明                                                         |
|------|----------|------------------------------------------------------------------|
| 1    | 房间无重叠   | 任意两个房间之间的重叠面积严格为0                             |
| 2    | 不超边界     | 房间的外轮廓不能超出户型边界（多边形/矩形）                   |
| 3    | 空间全占满   | 户型边界内部全部区域必须由功能房间或路径空间占据，无剩余空间 |
| 4    | 所有房间分配 | 要求布置的房间必须完整地被安置                                 |

**软约束**（带评分权重，鼓励满足，但非强制）：

| 序号 | 约束项     | 约束说明                             | 权重 |
|------|------------|--------------------------------------|------|
| 1    | 联通关系   | 满足房间间指定的相邻关系，越多越好   | 0.3  |
| 2    | 面积范围   | 房间面积在规定的上下限范围内         | 0.2  |
| 3    | 朝向要求   | 指定房间位于户型边界特定朝向         | 0.2  |
| 4    | 开窗要求   | 需要开窗的房间靠近可开窗的户型外墙   | 0.2  |
| 5    | 长宽比例   | 房间长宽比例满足设定的合理范围       | 0.1  |

以上权重可在算法实现后进一步调整。

---

## 三、整体技术方案：PSO + MCTS 算法框架  

算法核心思想：

- PSO 负责确定**房间的长宽尺寸**（尺寸作为粒子优化变量）。
- MCTS 在给定尺寸下确定**房间的坐标位置**（通过节点剪枝控制布局合理性）。
- 通过布局的综合评分函数来评估方案质量，PSO 根据评分更新粒子参数。

### 算法整体流程  

```
输入条件 → 初始化房间尺寸（PSO 粒子）
  ↓
循环：
    粒子并行（多线程/进程）
    每个粒子 → 运行 MCTS 安排房间位置
            → 计算布局评分（满足约束的得分）
            → 返回粒子适应度
    ↓
    PSO 更新粒子（基于适应度更新）
    ↓
收敛或达到迭代数 → 输出最佳布局结果
```

---

## 四、粒子群优化（PSO）详细设定  

- **编码方式**：
  - 每个房间长、宽尺寸均为以300mm整数倍为单位。
  - 粒子维度为：房间数量 × 2（每个房间的长和宽）。

- **粒子数量与迭代**：
  - 粒子数：建议20~30个。
  - 最大迭代次数：50~100（初期调试时可适当减少）。

---

## 五、蒙特卡洛树搜索（MCTS）详细设定  

### MCTS四要素定义：

- **状态(S)**：
  - 已布置的房间集合（坐标+长宽）。
  - 剩余待布置的房间集合。

- **动作(A)**：
  - 下一个房间的位置坐标选择（房间已确定尺寸）。

- **转移函数(F)**：
  - 每次选定位置坐标后，更新户型布置状态。

- **奖励(R)**：
  - 根据综合评价函数给出评分（见下一部分）。

### 节点剪枝（关键实现点）：

在每次布置下一个房间时，过滤明显不满足条件的位置，包括：

- 超出边界的位置。
- 会导致房间明显重叠的位置。
- 不满足朝向要求和开窗要求的位置。
- 破坏房间连接关系的位置（无法满足相邻需求）。

---

## 六、布局评价函数  

布局综合评分 = 硬约束惩罚（若违背则极低分）+ 软约束加权得分。

- 违背任何硬约束直接给极低评分，淘汰方案。
- 软约束得分为加权总和（权重见前表）。

```
评分 = 基础分(硬约束满足为基准分100分，违背为0分)
     + 软约束分(联通关系×0.3 + 面积范围×0.2 + 朝向要求×0.2
              + 开窗要求×0.2 + 长宽比例×0.1）×100
```

---

## 七、建议的程序模块划分  

| 模块                      | 功能                                          |
|---------------------------|----------------------------------------------|
| InputHandler              | 数据输入与预处理                               |
| ParticleSwarmOptimizer    | 粒子群算法，负责房间尺寸优化                     |
| MonteCarloTreeSearch      | MCTS布局搜索，负责位置确定和剪枝                 |
| LayoutEvaluator           | 布局评价函数，返回适应度评分                     |
| GeometryUtils             | 几何计算：重叠检查、边界判断、面积计算等         |
| OutputVisualizer          | 输出布局结果可视化                      |

---

## 八、可能的进阶和优化方向（暂不考虑）  

先实现以上方案后，再考虑：

- 支持更复杂户型边界（非矩形户型）。
- 增加户型类型多样性（复式、跃层户型等）。
- 增加更复杂的软约束（如空间隐私性、动线便捷性、风水学考量等）。
- 提高搜索效率（空间划分、预处理缓存、更高效几何运算）。

---

## 九、小结  


该方案先实现基础功能和约束，再逐步迭代扩展，避免一次实现过于复杂，难以调试。
### 注意：
- 要在main.py中设定好所有可调整的超参数，便于后续调试和优化。
- 要考虑path（过道），具体参考论文中描述。
- 由于本solver是一整个完整系统中的求解器部分，而在求解器之前还有一个预处理器部分，预处理器的功能是将输入的户型边界、房间类型、房间数量等信息转化为求解器可以理解的格式，因此在实现时需要考虑到预处理器的输入输出格式。具体参考prompt_template_constraints_rooms.txt中的约束条件描述。
- txt文件中暂未提到的输入，如“户型边界信息”，请自行设计，要求合理并与当前结构相兼容。
- 代码中的房间名等参数用英文表示，便于后续处理，代码注释中可用中文。
- 代码中涉及的函数、类、变量等命名要简洁明了，便于后续维护和扩展。